@medium(
    name='rule_lldp_dos_vulnerability',
    platform=['cisco_nxos', 'cisco_fxos'],
    commands=dict(
        show_feature='show feature | include lldp',
        show_lldp_traffic='show lldp traffic'
    ),
)
def rule_lldp_dos_vulnerability(configuration, commands, device, devices):
    """
    This rule checks for the presence of the LLDP feature on Cisco FXOS and NX-OS devices.
    The vulnerability (CVE-2024-20294) allows an unauthenticated, adjacent attacker to cause
    a denial of service (DoS) condition by sending crafted LLDP packets. The test ensures
    that the LLDP feature is either disabled or handled properly to prevent exploitation.
    """

    # Check if LLDP is enabled on the device
    lldp_enabled = 'enabled' in commands.show_feature
    assert not lldp_enabled, (
        "LLDP is enabled on the device, which is vulnerable to CVE-2024-20294. "
        "Consider upgrading to a fixed software version."
    )

    # If LLDP is enabled, check if the LLDP service is running correctly
    if lldp_enabled:
        # Check the LLDP traffic command output for service status
        service_not_enabled = 'Service not enabled' in commands.show_lldp_traffic
        assert not service_not_enabled, (
            "LLDP service is not running. This may indicate repeated crashes due to CVE-2024-20294. "
            "A device reload may be required to restore LLDP functionality."
        )

    # Additional check for LLDP configuration in the device's configuration
    # This is a safeguard to ensure LLDP is not accidentally enabled on interfaces
    assert 'lldp receive' not in configuration, (
        "LLDP receive is configured on one or more interfaces. "
        "Ensure LLDP is disabled on all interfaces to mitigate CVE-2024-20294."
    )
