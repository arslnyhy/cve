from comfy import medium

@medium(
    name='rule_cve202420284',
    platform=['cisco_nxos'],
    commands=dict(show_version='show version'),
)
def rule_cve202420284(configuration, commands, device, devices):
    """
    This rule checks for the presence of CVE-2024-20284 vulnerability in Cisco NX-OS devices.
    The vulnerability allows an authenticated, low-privileged, local attacker to escape the Python
    sandbox and gain unauthorized access to the underlying operating system of the device.
    """
    # Extract the software version from the 'show version' command output
    show_version_output = commands.show_version

    # List of vulnerable software versions from the notepad
    vulnerable_versions = [
        # 6.0(2) versions
        '6.0(2)A6(1)', '6.0(2)A6(1a)', '6.0(2)A6(2)', '6.0(2)A6(2a)', '6.0(2)A6(3)', 
        '6.0(2)A6(3a)', '6.0(2)A6(4)', '6.0(2)A6(4a)', '6.0(2)A6(5)', '6.0(2)A6(5a)', 
        '6.0(2)A6(5b)', '6.0(2)A6(6)', '6.0(2)A6(7)', '6.0(2)A6(8)', '6.0(2)A8(1)', 
        '6.0(2)A8(2)', '6.0(2)A8(3)', '6.0(2)A8(4)', '6.0(2)A8(4a)', '6.0(2)A8(5)',
        '6.0(2)A8(6)', '6.0(2)A8(7)', '6.0(2)A8(7a)', '6.0(2)A8(7b)', '6.0(2)A8(8)',
        '6.0(2)A8(9)', '6.0(2)A8(10)', '6.0(2)A8(10a)', '6.0(2)A8(11)', '6.0(2)A8(11a)',
        '6.0(2)A8(11b)', '6.0(2)U6(1)', '6.0(2)U6(1a)', '6.0(2)U6(2)', '6.0(2)U6(2a)',
        '6.0(2)U6(3)', '6.0(2)U6(3a)', '6.0(2)U6(4)', '6.0(2)U6(4a)', '6.0(2)U6(5)',
        '6.0(2)U6(5a)', '6.0(2)U6(5b)', '6.0(2)U6(5c)', '6.0(2)U6(6)', '6.0(2)U6(7)',
        '6.0(2)U6(8)', '6.0(2)U6(9)', '6.0(2)U6(10)', '6.0(2)U6(10a)',
        # 6.2 versions
        '6.2(1)', '6.2(2)', '6.2(2a)', '6.2(3)', '6.2(5)', '6.2(5a)', '6.2(5b)', '6.2(6)',
        '6.2(6a)', '6.2(6b)', '6.2(7)', '6.2(8)', '6.2(8a)', '6.2(8b)', '6.2(9)', '6.2(9a)',
        '6.2(9b)', '6.2(9c)', '6.2(10)', '6.2(11)', '6.2(11b)', '6.2(11c)', '6.2(11d)',
        '6.2(11e)', '6.2(12)', '6.2(13)', '6.2(13a)', '6.2(13b)', '6.2(14)', '6.2(14a)',
        '6.2(14b)', '6.2(15)', '6.2(16)', '6.2(17)', '6.2(17a)', '6.2(18)', '6.2(19)',
        '6.2(20)', '6.2(20a)', '6.2(21)', '6.2(22)', '6.2(23)', '6.2(24)', '6.2(24a)',
        '6.2(25)', '6.2(26)', '6.2(27)', '6.2(29)', '6.2(31)', '6.2(33)',
        # 7.0(3) versions
        '7.0(3)F1(1)', '7.0(3)F2(1)', '7.0(3)F2(2)', '7.0(3)F3(1)', '7.0(3)F3(2)',
        '7.0(3)F3(3)', '7.0(3)F3(3a)', '7.0(3)F3(3c)', '7.0(3)F3(4)', '7.0(3)F3(5)',
        '7.0(3)I4(1)', '7.0(3)I4(1t)', '7.0(3)I4(2)', '7.0(3)I4(3)', '7.0(3)I4(4)',
        '7.0(3)I4(5)', '7.0(3)I4(6)', '7.0(3)I4(6t)', '7.0(3)I4(7)', '7.0(3)I4(8)',
        '7.0(3)I4(8a)', '7.0(3)I4(8b)', '7.0(3)I4(8z)', '7.0(3)I4(9)', '7.0(3)I5(1)',
        '7.0(3)I5(2)', '7.0(3)I5(3)', '7.0(3)I5(3a)', '7.0(3)I5(3b)', '7.0(3)I6(1)',
        '7.0(3)I6(2)', '7.0(3)I7(1)', '7.0(3)I7(2)', '7.0(3)I7(3)', '7.0(3)I7(3z)',
        '7.0(3)I7(4)', '7.0(3)I7(5)', '7.0(3)I7(5a)', '7.0(3)I7(6)', '7.0(3)I7(6z)',
        '7.0(3)I7(7)', '7.0(3)I7(8)', '7.0(3)I7(9)', '7.0(3)I7(9w)', '7.0(3)I7(10)',
        '7.0(3)IC4(4)', '7.0(3)IM3(1)', '7.0(3)IM3(2)', '7.0(3)IM3(2a)', '7.0(3)IM3(2b)',
        '7.0(3)IM3(3)', '7.0(3)IM7(2)', '7.0(3)IA7(1)', '7.0(3)IA7(2)',
        # 7.1-7.3 versions
        '7.1(0)N1(1)', '7.1(0)N1(1a)', '7.1(0)N1(1b)', '7.1(1)N1(1)', '7.1(1)N1(1a)',
        '7.1(2)N1(1)', '7.1(2)N1(1a)', '7.1(3)N1(1)', '7.1(3)N1(2)', '7.1(3)N1(2a)',
        '7.1(3)N1(3)', '7.1(3)N1(4)', '7.1(3)N1(5)', '7.1(4)N1(1)', '7.1(4)N1(1a)',
        '7.1(4)N1(1c)', '7.1(4)N1(1d)', '7.1(5)N1(1)', '7.1(5)N1(1b)',
        '7.2(0)D1(1)', '7.2(1)D1(1)', '7.2(2)D1(1)', '7.2(2)D1(2)', '7.2(2)D1(3)',
        '7.2(2)D1(4)',
        '7.3(0)D1(1)', '7.3(0)DX(1)', '7.3(0)DY(1)', '7.3(0)N1(1)', '7.3(0)N1(1a)',
        '7.3(0)N1(1b)', '7.3(1)D1(1)', '7.3(1)DY(1)', '7.3(1)N1(1)', '7.3(2)D1(1)',
        '7.3(2)D1(1d)', '7.3(2)D1(2)', '7.3(2)D1(3)', '7.3(2)D1(3a)', '7.3(2)N1(1)',
        '7.3(2)N1(1b)', '7.3(2)N1(1c)', '7.3(3)D1(1)', '7.3(3)N1(1)', '7.3(4)D1(1)',
        '7.3(4)N1(1)', '7.3(4)N1(1a)', '7.3(5)D1(1)', '7.3(5)N1(1)', '7.3(6)D1(1)',
        '7.3(6)N1(1)', '7.3(6)N1(1a)', '7.3(7)D1(1)', '7.3(7)N1(1)', '7.3(7)N1(1a)',
        '7.3(7)N1(1b)', '7.3(8)D1(1)', '7.3(8)N1(1)', '7.3(8)N1(1a)', '7.3(8)N1(1b)',
        '7.3(9)D1(1)', '7.3(9)N1(1)', '7.3(10)N1(1)', '7.3(11)N1(1)', '7.3(11)N1(1a)',
        '7.3(12)N1(1)', '7.3(13)N1(1)', '7.3(14)N1(1)',
        # 8.x versions
        '8.0(1)', '8.1(1)', '8.1(1a)', '8.1(1b)', '8.1(2)', '8.1(2a)', '8.2(1)', '8.2(2)',
        '8.2(3)', '8.2(4)', '8.2(5)', '8.2(6)', '8.2(7)', '8.2(7a)', '8.2(8)', '8.2(9)',
        '8.2(10)', '8.2(11)', '8.3(1)', '8.3(2)', '8.4(1)', '8.4(1a)', '8.4(2)', '8.4(2a)',
        '8.4(2b)', '8.4(2c)', '8.4(2d)', '8.4(2e)', '8.4(2f)', '8.4(3)', '8.4(4)',
        '8.4(4a)', '8.4(5)', '8.4(6)', '8.4(6a)', '8.4(7)', '8.4(8)', '8.4(9)', '8.5(1)',
        # 9.x versions
        '9.2(1)', '9.2(1a)', '9.2(2)', '9.2(2t)', '9.2(2v)', '9.2(3)', '9.2(3y)', '9.2(4)',
        '9.3(1)', '9.3(1z)', '9.3(2)', '9.3(2a)', '9.3(3)', '9.3(4)', '9.3(5)', '9.3(5w)',
        '9.3(6)', '9.3(7)', '9.3(7a)', '9.3(7k)', '9.3(8)', '9.3(9)', '9.3(10)', '9.3(11)',
        '9.3(12)', '9.3(13)', '9.4(1)', '9.4(1a)',
        # 10.x versions
        '10.1(1)', '10.1(2)', '10.1(2t)', '10.2(1)', '10.2(1q)', '10.2(2)', '10.2(2a)',
        '10.2(3)', '10.2(3t)', '10.2(3v)', '10.2(4)', '10.2(5)', '10.2(6)', '10.2(7)',
        '10.3(1)', '10.3(2)', '10.3(3)', '10.3(3o)', '10.3(3p)', '10.3(3q)', '10.3(3r)',
        '10.3(3w)', '10.3(3x)', '10.3(4)', '10.3(4a)', '10.3(4g)', '10.3(5)', '10.3(99w)',
        '10.3(99x)', '10.4(1)', '10.4(2)', '10.4(3)'
    ]

    # Check if the current version is in the list of vulnerable versions
    version_vulnerable = any(version in show_version_output for version in vulnerable_versions)

    # Assert that the device is not running a vulnerable version
    # If the assertion fails, it indicates the device is vulnerable
    assert not version_vulnerable, (
        f"Device {device.name} is running a vulnerable version of Cisco NX-OS software. "
        "Please upgrade to a fixed version to mitigate CVE-2024-20284, CVE-2024-20285, and CVE-2024-20286. "
        "For more information, see https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-nxos-psbe-ce-YvbTn5du"
    )
